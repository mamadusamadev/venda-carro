{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}{{ title }} - Dashboard{% endblock %}

{% block extra_css %}
<style>
    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .section-body {
        padding: 25px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .equipment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .equipment-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }
    
    .equipment-item:hover {
        background: #e9ecef;
    }
    
    .equipment-item input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
    }
    
    .image-upload-area {
        border: 2px dashed #667eea;
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .image-upload-area:hover {
        border-color: #5a6fd8;
        background: #f0f3ff;
    }
    
    .image-upload-area.dragover {
        border-color: #4caf50;
        background: #f1f8e9;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 15px;
    }
    
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .image-preview {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
        background: #f8f9fa;
    }
    
    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .image-preview .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .required-field {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-1">{{ title }}</h2>
                    <p class="text-muted mb-0">Adicione um novo carro ao seu inventário</p>
                </div>
                <a href="{% url 'dashboard:my_cars' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Form -->
            <form method="post" enctype="multipart/form-data" id="carForm">
                {% csrf_token %}
                
                <!-- Informações Básicas -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-info-circle me-2"></i>Informações Básicas
                    </h3>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-12 form-group">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    {{ form.title.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.title.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="{{ form.brand.id_for_label }}" class="form-label">
                                    {{ form.brand.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.brand }}
                                {% if form.brand.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.brand.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="{{ form.car_model.id_for_label }}" class="form-label">
                                    {{ form.car_model.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.car_model }}
                                {% if form.car_model.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.car_model.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="{{ form.year.id_for_label }}" class="form-label">
                                    {{ form.year.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.year }}
                                {% if form.year.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.year.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.price.id_for_label }}" class="form-label">
                                    {{ form.price.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.price.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.mileage.id_for_label }}" class="form-label">
                                    {{ form.mileage.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.mileage }}
                                {% if form.mileage.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.mileage.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="{{ form.condition.id_for_label }}" class="form-label">
                                    {{ form.condition.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.condition }}
                                {% if form.condition.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.condition.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="{{ form.color.id_for_label }}" class="form-label">
                                    {{ form.color.label }}
                                </label>
                                {{ form.color }}
                                {% if form.color.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.color.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Especificações Técnicas -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-cogs me-2"></i>Especificações Técnicas
                    </h3>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="{{ form.fuel_type.id_for_label }}" class="form-label">
                                    {{ form.fuel_type.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.fuel_type }}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="{{ form.transmission.id_for_label }}" class="form-label">
                                    {{ form.transmission.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.transmission }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="{{ form.engine_size.id_for_label }}" class="form-label">
                                    {{ form.engine_size.label }}
                                </label>
                                {{ form.engine_size }}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.power.id_for_label }}" class="form-label">
                                    {{ form.power.label }}
                                </label>
                                {{ form.power }}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.doors.id_for_label }}" class="form-label">
                                    {{ form.doors.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.doors }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="{{ form.seats.id_for_label }}" class="form-label">
                                    {{ form.seats.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.seats }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Localização -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-map-marker-alt me-2"></i>Localização
                    </h3>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-12 form-group">
                                <label for="{{ form.location.id_for_label }}" class="form-label">
                                    {{ form.location.label }}
                                </label>
                                {{ form.location }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="{{ form.city.id_for_label }}" class="form-label">
                                    {{ form.city.label }} <span class="required-field">*</span>
                                </label>
                                {{ form.city }}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.district.id_for_label }}" class="form-label">
                                    {{ form.district.label }}
                                </label>
                                {{ form.district }}
                            </div>
                            
                            <div class="col-md-4 form-group">
                                <label for="{{ form.postal_code.id_for_label }}" class="form-label">
                                    {{ form.postal_code.label }}
                                </label>
                                {{ form.postal_code }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imagens -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-images me-2"></i>Imagens do Carro
                    </h3>
                    <div class="section-body">
                        <div class="form-group">
                            <label class="form-label">Adicionar Imagens</label>
                            <div class="image-upload-area" onclick="document.getElementById('id_images').click()">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h5>Clique ou arraste imagens aqui</h5>
                                <p class="text-muted mb-0">Máximo 10 imagens • JPG, PNG • Máx. 5MB cada</p>
                            </div>
                            {{ form.images }}
                            {% if form.images.errors %}
                                <div class="text-danger mt-2">
                                    {% for error in form.images.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Preview das imagens -->
                            <div id="imagePreviewContainer" class="image-preview-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Equipamentos -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-list-check me-2"></i>Equipamentos
                    </h3>
                    <div class="section-body">
                        <div class="equipment-grid">
                            <div class="equipment-item">
                                {{ form.air_conditioning }}
                                <label for="{{ form.air_conditioning.id_for_label }}">{{ form.air_conditioning.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.power_steering }}
                                <label for="{{ form.power_steering.id_for_label }}">{{ form.power_steering.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.electric_windows }}
                                <label for="{{ form.electric_windows.id_for_label }}">{{ form.electric_windows.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.airbags }}
                                <label for="{{ form.airbags.id_for_label }}">{{ form.airbags.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.abs_brakes }}
                                <label for="{{ form.abs_brakes.id_for_label }}">{{ form.abs_brakes.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.alarm_system }}
                                <label for="{{ form.alarm_system.id_for_label }}">{{ form.alarm_system.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.alloy_wheels }}
                                <label for="{{ form.alloy_wheels.id_for_label }}">{{ form.alloy_wheels.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.cd_player }}
                                <label for="{{ form.cd_player.id_for_label }}">{{ form.cd_player.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.leather_seats }}
                                <label for="{{ form.leather_seats.id_for_label }}">{{ form.leather_seats.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.sunroof }}
                                <label for="{{ form.sunroof.id_for_label }}">{{ form.sunroof.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.gps_navigation }}
                                <label for="{{ form.gps_navigation.id_for_label }}">{{ form.gps_navigation.label }}</label>
                            </div>
                            <div class="equipment-item">
                                {{ form.backup_camera }}
                                <label for="{{ form.backup_camera.id_for_label }}">{{ form.backup_camera.label }}</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Descrição -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-align-left me-2"></i>Descrição
                    </h3>
                    <div class="section-body">
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.description.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Estado do Anúncio -->
                <div class="section-card">
                    <h3 class="section-header">
                        <i class="fas fa-toggle-on me-2"></i>Estado do Anúncio
                    </h3>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    {{ form.status.label }}
                                </label>
                                {{ form.status }}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <div class="equipment-item">
                                    {{ form.is_featured }}
                                    <label for="{{ form.is_featured.id_for_label }}">{{ form.is_featured.label }}</label>
                                </div>
                                <small class="text-muted">{{ form.is_featured.help_text }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="section-card">
                    <div class="section-body text-end">
                        <a href="{% url 'dashboard:my_cars' %}" class="btn btn-secondary me-3">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Carro
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Carregamento dinâmico de modelos
    $('#id_brand').change(function() {
        const brandId = $(this).val();
        const modelSelect = $('#id_car_model');
        
        modelSelect.html('<option value="">A carregar...</option>');
        
        if (brandId) {
            $.ajax({
                url: '{% url "dashboard:get_car_models" %}',
                type: 'POST',
                data: {
                    'brand_id': brandId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    modelSelect.html('<option value="">Selecione um modelo</option>');
                    $.each(data.models, function(index, model) {
                        modelSelect.append($('<option></option>').attr('value', model.id).text(model.name));
                    });
                },
                error: function() {
                    modelSelect.html('<option value="">Erro ao carregar modelos</option>');
                }
            });
        } else {
            modelSelect.html('<option value="">Selecione primeiro uma marca</option>');
        }
    });
    
    // Preview de imagens
    $('#id_images').change(function() {
        const files = this.files;
        const previewContainer = $('#imagePreviewContainer');
        previewContainer.empty();
        
        if (files.length > 10) {
            alert('Máximo de 10 imagens permitidas');
            this.value = '';
            return;
        }
        
        Array.from(files).forEach((file, index) => {
            if (file.size > 5 * 1024 * 1024) {
                alert(`A imagem ${file.name} é muito grande. Máximo 5MB.`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = $(`
                    <div class="image-preview">
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-btn" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
                previewContainer.append(preview);
            };
            reader.readAsDataURL(file);
        });
    });
    
    // Drag & Drop para upload de imagens
    const uploadArea = $('.image-upload-area');
    
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        $('#id_images')[0].files = files;
        $('#id_images').trigger('change');
    });
});

function removeImage(index) {
    // Remove a preview
    $(`.image-preview`).eq(index).remove();
    
    // Reset o input file (não é possível remover arquivos específicos)
    $('#id_images').val('');
    $('#imagePreviewContainer').empty();
}
</script>
{% endblock %} 