{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - CarZone{% endblock %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-lock me-2"></i>
                    Alterar Palavra-passe
                </h5>
                <a href="{% url 'dashboard:profile' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Voltar
                </a>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Por segurança, necessita da sua palavra-passe atual para definir uma nova.
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.current_password.id_for_label }}" class="form-label">
                            {{ form.current_password.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.current_password }}
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('{{ form.current_password.id_for_label }}', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.current_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.current_password.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                            {{ form.new_password.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.new_password }}
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('{{ form.new_password.id_for_label }}', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.new_password.errors.0 }}
                            </div>
                        {% endif %}
                        {% if form.new_password.help_text %}
                            <div class="form-text">{{ form.new_password.help_text }}</div>
                        {% endif %}
                        
                        <!-- Indicador de força da palavra-passe -->
                        <div class="mt-2">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="password-strength-text" class="text-muted">Digite uma palavra-passe</small>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                            {{ form.confirm_password.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.confirm_password }}
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('{{ form.confirm_password.id_for_label }}', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.confirm_password.errors.0 }}
                            </div>
                        {% endif %}
                        
                        <!-- Indicador de correspondência -->
                        <div class="mt-2">
                            <small id="password-match-text" class="text-muted">As palavras-passe devem coincidir</small>
                        </div>
                    </div>
                    
                    <!-- Critérios de segurança -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt me-2"></i>
                                Critérios de Segurança
                            </h6>
                            <ul class="list-unstyled mb-0">
                                <li id="length-check">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Pelo menos 8 caracteres
                                </li>
                                <li id="lowercase-check">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Pelo menos uma letra minúscula
                                </li>
                                <li id="uppercase-check">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Pelo menos uma letra maiúscula
                                </li>
                                <li id="number-check">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Pelo menos um número
                                </li>
                                <li id="special-check">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Pelo menos um carácter especial
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Erros globais do formulário -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}
                    
                    <!-- Botões -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'dashboard:profile' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                            <i class="fas fa-save me-1"></i>
                            Alterar Palavra-passe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle visibilidade da palavra-passe
function togglePasswordVisibility(fieldId, button) {
    const field = document.getElementById(fieldId);
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Verificar força da palavra-passe
function checkPasswordStrength(password) {
    let score = 0;
    const checks = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Atualizar indicadores visuais
    Object.keys(checks).forEach(check => {
        const element = document.getElementById(check + '-check');
        const icon = element.querySelector('i');
        
        if (checks[check]) {
            icon.className = 'fas fa-check text-success me-2';
            score++;
        } else {
            icon.className = 'fas fa-times text-danger me-2';
        }
    });
    
    // Atualizar barra de progresso
    const progressBar = document.getElementById('password-strength-bar');
    const progressText = document.getElementById('password-strength-text');
    
    const percentage = (score / 5) * 100;
    progressBar.style.width = percentage + '%';
    
    if (score === 0) {
        progressBar.className = 'progress-bar';
        progressText.textContent = 'Digite uma palavra-passe';
        progressText.className = 'text-muted';
    } else if (score <= 2) {
        progressBar.className = 'progress-bar bg-danger';
        progressText.textContent = 'Palavra-passe fraca';
        progressText.className = 'text-danger';
    } else if (score <= 3) {
        progressBar.className = 'progress-bar bg-warning';
        progressText.textContent = 'Palavra-passe média';
        progressText.className = 'text-warning';
    } else if (score <= 4) {
        progressBar.className = 'progress-bar bg-info';
        progressText.textContent = 'Palavra-passe boa';
        progressText.className = 'text-info';
    } else {
        progressBar.className = 'progress-bar bg-success';
        progressText.textContent = 'Palavra-passe forte';
        progressText.className = 'text-success';
    }
    
    return score >= 4; // Considerar válida se pelo menos 4 critérios forem atendidos
}

// Verificar se as palavras-passe coincidem
function checkPasswordMatch() {
    const newPassword = document.getElementById('{{ form.new_password.id_for_label }}').value;
    const confirmPassword = document.getElementById('{{ form.confirm_password.id_for_label }}').value;
    const matchText = document.getElementById('password-match-text');
    
    if (confirmPassword === '') {
        matchText.textContent = 'As palavras-passe devem coincidir';
        matchText.className = 'text-muted';
        return false;
    } else if (newPassword === confirmPassword) {
        matchText.textContent = 'Palavras-passe coincidem';
        matchText.className = 'text-success';
        return true;
    } else {
        matchText.textContent = 'As palavras-passe não coincidem';
        matchText.className = 'text-danger';
        return false;
    }
}

// Validar formulário
function validateForm() {
    const currentPassword = document.getElementById('{{ form.current_password.id_for_label }}').value;
    const newPassword = document.getElementById('{{ form.new_password.id_for_label }}').value;
    const confirmPassword = document.getElementById('{{ form.confirm_password.id_for_label }}').value;
    
    const hasCurrentPassword = currentPassword.length > 0;
    const isPasswordStrong = checkPasswordStrength(newPassword);
    const passwordsMatch = checkPasswordMatch();
    
    const isValid = hasCurrentPassword && isPasswordStrong && passwordsMatch;
    document.getElementById('submit-btn').disabled = !isValid;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const passwordFields = [
        '{{ form.current_password.id_for_label }}',
        '{{ form.new_password.id_for_label }}',
        '{{ form.confirm_password.id_for_label }}'
    ];
    
    passwordFields.forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', validateForm);
    });
    
    // Validação inicial
    validateForm();
});
</script>
{% endblock %}
