{% extends 'dashboard/base.html' %}

{% block title %}Chat - {{ other_user.get_full_name|default:other_user.username }} - CarZone{% endblock %}
{% block page_title %}Chat sobre {{ car.title }}{% endblock %}

{% block content %}
<div class="row h-100 {% if chat_room.status == 'closed' %}chat-closed{% endif %}">
    <div class="col-12">
        <!-- Header do Chat -->
        <div class="card mb-0" style="height: calc(100vh - 200px);">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-user-circle fs-3"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">{{ other_user.get_full_name|default:other_user.username }}</h6>
                            <small class="opacity-75">
                                {% if is_buyer %}Vendedor{% else %}Comprador{% endif %}
                                {% if chat_room.status == 'active' %} ‚Ä¢ 
                                <span id="user-status" class="text-warning">Offline</span>
                                {% else %} ‚Ä¢ 
                                <span class="badge bg-secondary">Chat Encerrado</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <!-- Informa√ß√µes do Carro -->
                        <div class="me-3">
                            <small class="opacity-75">{{ car.brand.name }} {{ car.car_model.name }} ‚Ä¢ ‚Ç¨{{ car.price|floatformat:0 }}</small>
                        </div>
                        
                        <!-- Bot√µes de A√ß√£o -->
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-light" onclick="viewCarDetails()">
                                <i class="fas fa-car"></i>
                            </button>
                            {% if chat_room.status == 'active' %}
                            <button class="btn btn-sm btn-outline-light" onclick="closeChat()" id="close-chat-btn">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √Årea de Mensagens -->
            <div class="card-body p-0 d-flex flex-column" style="height: calc(100% - 120px);">
                <div class="flex-grow-1 overflow-auto p-3" id="messages-container">
                        <!-- Status do Chat -->
                        {% if chat_room.status == 'closed' %}
                        <div class="alert alert-info text-center mb-3">
                            <i class="fas fa-lock me-2"></i>
                            <strong>Chat Encerrado</strong><br>
                            {% if close_reason == 'inactivity' %}
                                <small>Fechado automaticamente por inatividade em {{ chat_room.closed_at|date:"d/m/Y H:i" }}</small>
                            {% else %}
                                <small>Fechado por {{ chat_room.closed_by.get_full_name|default:chat_room.closed_by.username }} em {{ chat_room.closed_at|date:"d/m/Y H:i" }}</small>
                            {% endif %}
                            <br><small class="text-muted">Esta conversa √© apenas para visualiza√ß√£o</small>
                        </div>
                        {% endif %}
                        
                        <!-- Mensagens Existentes -->
                        {% for message in messages %}
                        <div class="message mb-3 {% if message.sender == request.user %}sent{% else %}received{% endif %}" 
                             data-message-id="{{ message.id }}">
                            <div class="d-flex {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                                <div class="message-content {% if message.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %} p-3 rounded-3" 
                                     style="max-width: 70%;">
                                    
                                    <!-- Anexo se existir -->
                                    {% if message.attachment %}
                                        <div class="message-attachment mb-2">
                                            {% if message.is_image %}
                                                <img src="{{ message.attachment.url }}" alt="{{ message.attachment_name|default:message.attachment.name }}" 
                                                     class="img-fluid rounded" style="max-width: 300px; max-height: 200px;">
                                            {% else %}
                                                <div class="d-flex align-items-center p-2 rounded bg-white bg-opacity-10">
                                                    <i class="{{ message.get_file_icon }} me-2"></i>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold">{{ message.attachment_name|default:message.attachment.name }}</div>
                                                        <small class="opacity-75">{{ message.get_file_size_formatted }}</small>
                                                    </div>
                                                    <a href="{{ message.attachment.url }}" download="{{ message.attachment_name|default:message.attachment.name }}" 
                                                       class="btn btn-sm btn-outline-{% if message.sender == request.user %}light{% else %}primary{% endif %}">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Texto se existir -->
                                    {% if message.content %}
                                        <div class="message-text">{{ message.content }}</div>
                                    {% endif %}
                                    
                                    <div class="message-time mt-1">
                                        <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %}">
                                            {{ message.created_at|date:"H:i" }}
                                            {% if message.is_edited %}
                                                <i class="fas fa-edit ms-1" title="Editada"></i>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-5" id="no-messages">
                            <i class="fas fa-comments fs-1 mb-3"></i>
                            <p>Ainda n√£o h√° mensagens neste chat.</p>
                            <p>Seja o primeiro a enviar uma mensagem!</p>
                        </div>
                        {% endfor %}
                    
                    <!-- Indicador de Digita√ß√£o (apenas para chats ativos) -->
                    {% if chat_room.status == 'active' %}
                    <div id="typing-indicator" class="message mb-3 received" style="display: none;">
                        <div class="d-flex justify-content-start">
                            <div class="bg-light p-3 rounded-3">
                                <div class="typing-animation">
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                </div>
                                <small class="text-muted">{{ other_user.username }} est√° a digitar...</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- √Årea de Input -->
                {% if chat_room.status == 'active' %}
                <div class="border-top p-3">
                    {% csrf_token %}
                    
                    <!-- Preview de arquivo -->
                    <div id="file-preview" class="mb-2" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i id="file-icon" class="fas fa-file me-2"></i>
                            <div class="flex-grow-1">
                                <strong id="file-name"></strong>
                                <div class="small text-muted" id="file-size"></div>
                            </div>
                            <button type="button" class="btn-close" id="remove-file"></button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" id="file-button" title="Enviar arquivo">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" class="form-control" id="message-input" 
                               placeholder="Digite sua mensagem..." maxlength="1000">
                        <button class="btn btn-primary" type="button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Input de arquivo oculto -->
                    <input type="file" id="file-input" style="display: none;" 
                           accept="image/*,application/pdf,.doc,.docx,.txt,.zip,.rar">
                    
                    <!-- Indicador de digita√ß√£o do input -->
                    <div id="typing-status" class="mt-2" style="display: none;">
                        <small class="text-muted">
                            <i class="fas fa-circle-notch fa-spin me-1"></i>
                            {{ other_user.get_full_name|default:other_user.username }} est√° a digitar...
                        </small>
                    </div>
                    
                    <small class="text-muted">Pressione Enter para enviar ‚Ä¢ Clique üìé para anexar arquivo</small>
                </div>
                {% else %}
                <div class="border-top p-3 bg-light">
                    <div class="text-center text-muted">
                        <i class="fas fa-lock me-2"></i>
                        Este chat est√° fechado
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Fechar Chat -->
<div class="modal fade" id="closeChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fechar Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja fechar este chat?</p>
                <p class="text-muted small">Esta a√ß√£o n√£o pode ser desfeita. O chat ser√° arquivado e n√£o ser√° poss√≠vel enviar mais mensagens.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmCloseChat()">Fechar Chat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.message.sent .message-content {
    margin-left: auto;
}

.message.received .message-content {
    margin-right: auto;
}

#messages-container {
    scroll-behavior: smooth;
}

/* For√ßa a visualiza√ß√£o das mensagens */
.message {
    display: block !important;
    margin-bottom: 1rem !important;
}

.message .d-flex {
    display: flex !important;
}

.message-content {
    display: block !important;
    padding: 1rem !important;
    border-radius: 0.5rem !important;
    max-width: 70% !important;
    background-color: #f8f9fa !important;
    border: 1px solid #dee2e6 !important;
}

/* Estilos espec√≠ficos para mensagens enviadas */
.message.sent .message-content,
.message.sent .bg-primary,
.message.sent .bg-light {
    background-color: #007bff !important;
    color: white !important;
    border: 1px solid #007bff !important;
}

/* Estilos espec√≠ficos para mensagens recebidas */
.message.received .message-content,
.message.received .bg-light,
.message.received .bg-primary {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border: 1px solid #dee2e6 !important;
}

/* Sobrescrever todas as classes Bootstrap */
.chat-closed .message .bg-light,
.chat-closed .message .bg-primary,
.message .bg-light,
.message .bg-primary {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border: 2px solid #dee2e6 !important;
    padding: 1rem !important;
    border-radius: 0.75rem !important;
    min-height: 50px !important;
    display: block !important;
}

.chat-closed .message.sent .bg-light,
.chat-closed .message.sent .bg-primary,
.message.sent .bg-light,
.message.sent .bg-primary {
    background-color: #6c757d !important;
    color: white !important;
    border: 2px solid #6c757d !important;
}

/* Classes Bootstrap espec√≠ficas */
.message .p-3 {
    padding: 1rem !important;
}

.message .rounded-3 {
    border-radius: 0.75rem !important;
}

.message-text {
    display: block !important;
    word-wrap: break-word !important;
    min-height: 20px !important;
    line-height: 1.4 !important;
    font-size: 14px !important;
}

.message-time {
    display: block !important;
    margin-top: 0.25rem !important;
}

.typing-animation {
    display: inline-flex;
    gap: 3px;
    margin-right: 8px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.user-online {
    color: #ffc107 !important;
    font-weight: bold;
}

.user-offline {
    color: #6c757d !important;
}

.status-online {
    color: #ffc107 !important;
    font-weight: bold;
}

.status-offline {
    color: #6c757d !important;
}

/* Estilo para chat fechado */
.chat-closed #messages-container {
    /* Manter opacidade total para mensagens serem vis√≠veis */
    opacity: 1 !important;
}

.chat-closed .message-content {
    /* Manter opacidade total e adicionar borda sutil */
    opacity: 1 !important;
    border: 1px solid #dee2e6;
    background-color: #f8f9fa !important;
    display: block !important;
    visibility: visible !important;
}

.chat-closed .message.sent .message-content {
    background-color: #6c757d !important;
    color: white !important;
}

.chat-closed .message.received .message-content {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border: 1px solid #dee2e6;
}

/* Garantir que texto das mensagens seja vis√≠vel */
.chat-closed .message-text {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    color: inherit !important;
}

.chat-closed .message-time {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Esconder indicador de digita√ß√£o em chats fechados */
.chat-closed #typing-indicator,
.chat-closed #typing-status {
    display: none !important;
}

/* For√ßa esconder indicadores de digita√ß√£o por padr√£o */
#typing-indicator,
#typing-status {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}

/* S√≥ mostrar quando explicitamente ativado */
#typing-indicator.show-typing,
#typing-status.show-typing {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
    overflow: visible !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const chatRoomId = '{{ chat_room.id }}';
const currentUserId = '{{ request.user.id }}';
const currentUsername = '{{ request.user.username }}';
const otherUserId = '{{ other_user.id }}';
const otherUsername = '{{ other_user.username }}';

let chatSocket = null;
let typingTimer = null;
let isTyping = false;
let selectedFile = null;
let notificationSound = null;

// Conectar ao WebSocket
function connectWebSocket() {
    // N√£o conectar se o chat foi marcado como fechado
    if (window.chatClosed) {
        console.log('N√£o conectando WebSocket - chat est√° fechado');
        return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${chatRoomId}/`;
    
    chatSocket = new WebSocket(wsUrl);
    
    chatSocket.onopen = function(e) {
        console.log('Chat conectado via WebSocket');
        updateConnectionStatus(true);
        
        // Solicitar status inicial do outro utilizador
        console.log('Solicitando status inicial...');
        setTimeout(() => {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'action': 'request_status'
                }));
            }
        }, 500); // Aguardar 500ms para garantir que a conex√£o est√° est√°vel
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleWebSocketMessage(data);
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat desconectado');
        updateConnectionStatus(false);
        
        // Apenas reconectar se o chat estiver ativo e n√£o foi marcado como fechado
        {% if chat_room.status == 'active' %}
        if (!window.chatClosed) {
            // Tentar reconectar ap√≥s 3 segundos
            setTimeout(connectWebSocket, 3000);
        } else {
            console.log('Chat fechado - n√£o tentando reconectar');
        }
        {% else %}
        console.log('Chat fechado - n√£o tentando reconectar');
        {% endif %}
    };
    
    chatSocket.onerror = function(e) {
        console.error('Erro no WebSocket:', e);
    };
}

// Manipular mensagens do WebSocket
function handleWebSocketMessage(data) {
    console.log('WebSocket recebeu:', data);
    
    switch(data.type) {
        case 'message':
            console.log('Processando mensagem:', data);
            console.log('Anexo presente:', !!data.attachment_url);
            addMessage(data);
            break;
        case 'user_status':
            console.log('Status recebido:', data.user_id, data.status, 'otherUserId:', otherUserId);
            updateUserStatus(data.user_id, data.status);
            break;
        case 'typing':
            console.log('Recebido sinal de digita√ß√£o:', data.user_id, 'is_typing:', data.is_typing);
            showTypingIndicator(data.is_typing);
            break;
        case 'messages_read':
            markMessagesAsRead();
            break;
        case 'chat_closed':
            handleChatClosed(data);
            break;
        case 'error':
            console.error('Erro do WebSocket:', data.message);
            break;
    }
}

// Adicionar nova mensagem √† conversa
function addMessage(data) {
    console.log('addMessage chamada com:', data);
    const messagesContainer = document.getElementById('messages-container');
    const noMessages = document.getElementById('no-messages');
    
    if (noMessages) {
        console.log('Removendo indicador "no-messages"');
        noMessages.remove();
    }
    
    const messageDiv = document.createElement('div');
    const isOwn = data.sender_id === currentUserId;
    
    messageDiv.className = `message mb-3 ${isOwn ? 'sent' : 'received'}`;
    messageDiv.dataset.messageId = data.message_id;
    
    const timestamp = new Date(data.timestamp).toLocaleTimeString('pt-PT', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let messageContent = '';
    
    // Conte√∫do da mensagem baseado no tipo
    if (data.attachment_url) {
        // Mensagem com arquivo
        if (data.is_image) {
            // Imagem
            messageContent = `
                <div class="message-attachment mb-2">
                    <img src="${data.attachment_url}" alt="${data.attachment_name}" 
                         class="img-fluid rounded" style="max-width: 300px; max-height: 200px;">
                </div>
            `;
        } else {
            // Outros arquivos
            messageContent = `
                <div class="message-attachment mb-2">
                    <div class="d-flex align-items-center p-2 rounded bg-white bg-opacity-10">
                        <i class="${data.file_icon} me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${data.attachment_name}</div>
                            <small class="opacity-75">${data.file_size}</small>
                        </div>
                        <a href="${data.attachment_url}" download="${data.attachment_name}" 
                           class="btn btn-sm btn-outline-light">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
            `;
        }
    }
    
    // Adicionar texto se existir
    if (data.message) {
        messageContent += `<div class="message-text">${escapeHtml(data.message)}</div>`;
    }
    
    messageDiv.innerHTML = `
        <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
            <div class="message-content ${isOwn ? 'bg-primary text-white' : 'bg-light'} p-3 rounded-3" style="max-width: 70%;">
                ${messageContent}
                <div class="message-time mt-1">
                    <small class="${isOwn ? 'text-white-50' : 'text-muted'}">
                        ${timestamp}
                    </small>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Reproduzir som de notifica√ß√£o se n√£o for pr√≥pria mensagem
    if (!isOwn) {
        playNotificationSound();
    }
}

// Enviar mensagem via WebSocket
function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    // Verificar se h√° mensagem ou arquivo
    if (!message && !selectedFile) {
        console.log('Nenhuma mensagem ou arquivo para enviar');
        return;
    }
    
    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
        console.log('WebSocket n√£o est√° conectado');
        return;
    }
    
    const messageData = {
        'action': 'send_message',
        'message': message || '',
        'type': 'text'
    };
    
    // Adicionar dados do arquivo se selecionado
    if (selectedFile) {
        console.log('Enviando arquivo:', selectedFile.name);
        const reader = new FileReader();
        reader.onload = function(e) {
            messageData.file_data = e.target.result;
            messageData.file_name = selectedFile.name;
            
            console.log('Dados do arquivo preparados, enviando...');
            // Enviar mensagem com arquivo
            chatSocket.send(JSON.stringify(messageData));
            
            // Limpar
            messageInput.value = '';
            clearFileSelection();
            stopTyping();
        };
        reader.onerror = function(error) {
            console.error('Erro ao ler arquivo:', error);
            alert('Erro ao processar arquivo');
        };
        reader.readAsDataURL(selectedFile);
    } else {
        console.log('Enviando mensagem de texto:', message);
        // Enviar mensagem s√≥ com texto
        chatSocket.send(JSON.stringify(messageData));
        messageInput.value = '';
        stopTyping();
    }
}

// Indicar que est√° a digitar
function startTyping() {
    // N√£o processar digita√ß√£o se chat estiver fechado
    if (window.chatClosed) {
        return;
    }
    
    // Limpar timer anterior
    clearTimeout(typingTimer);
    
    // Enviar sinal de digita√ß√£o apenas se n√£o estiver j√° digitando
    if (!isTyping && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        isTyping = true;
        chatSocket.send(JSON.stringify({
            'action': 'typing',
            'is_typing': true
        }));
        console.log('Sinal de digita√ß√£o enviado: true');
    }
    
    // Sempre configurar timer para parar digita√ß√£o ap√≥s 3 segundos
    typingTimer = setTimeout(() => {
        console.log('Timer de digita√ß√£o expirou - chamando stopTyping');
        stopTyping();
    }, 3000);
}

function stopTyping() {
    console.log('stopTyping chamada - limpando estado de digita√ß√£o');
    
    // Sempre limpar o estado local de digita√ß√£o
    isTyping = false;
    clearTimeout(typingTimer);
    
    // Sempre enviar sinal de parar digita√ß√£o se WebSocket estiver conectado
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'action': 'typing',
            'is_typing': false
        }));
        console.log('Sinal de digita√ß√£o enviado: false');
    }
    
    // Garantir que indicadores locais sejam escondidos
    const typingIndicator = document.getElementById('typing-indicator');
    const typingStatus = document.getElementById('typing-status');
    if (typingIndicator) {
        typingIndicator.classList.remove('show-typing');
        typingIndicator.style.display = 'none';
        typingIndicator.style.visibility = 'hidden';
        console.log('Indicador de digita√ß√£o escondido');
    }
    if (typingStatus) {
        typingStatus.classList.remove('show-typing');
        typingStatus.style.display = 'none';
        typingStatus.style.visibility = 'hidden';
        console.log('Status de digita√ß√£o escondido');
    }
}

// Mostrar indicador de digita√ß√£o
function showTypingIndicator(isTypingNow) {
    console.log('showTypingIndicator chamada:', isTypingNow);
    
    // N√£o mostrar indicador se chat estiver fechado
    if (window.chatClosed) {
        console.log('Chat fechado - ignorando indicador de digita√ß√£o');
        return;
    }
    
    const typingIndicator = document.getElementById('typing-indicator');
    const typingStatus = document.getElementById('typing-status');
    
    if (isTypingNow) {
        console.log('Mostrando indicador de digita√ß√£o');
        if (typingIndicator) {
            typingIndicator.classList.add('show-typing');
            scrollToBottom();
        }
        if (typingStatus) {
            typingStatus.classList.add('show-typing');
        }
    } else {
        console.log('Escondendo indicador de digita√ß√£o');
        if (typingIndicator) {
            typingIndicator.classList.remove('show-typing');
        }
        if (typingStatus) {
            typingStatus.classList.remove('show-typing');
        }
    }
}

// Atualizar status do utilizador
function updateUserStatus(userId, status) {
    console.log('updateUserStatus chamado:', userId, status);
    console.log('Comparando:', userId, '===', otherUserId, '?', userId === otherUserId);
    
    if (userId === otherUserId) {
        const statusElement = document.getElementById('user-status');
        if (statusElement) {
            statusElement.textContent = status === 'online' ? 'Online' : 'Offline';
            // Usar cor amarela vibrante para online e cinza para offline
            statusElement.className = status === 'online' ? 'status-online' : 'status-offline';
            console.log('Status atualizado:', status, 'Classe:', statusElement.className);
        } else {
            console.error('Elemento user-status n√£o encontrado!');
        }
    } else {
        console.log('UserId n√£o corresponde ao otherUserId, ignorando');
    }
}

// Atualizar status da conex√£o
function updateConnectionStatus(isConnected) {
    // Pode adicionar indicador visual da conex√£o aqui
}

// Rolar para o final das mensagens
function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Inicializar som de notifica√ß√£o
function initializeNotificationSound() {
    // Criar √°udio para notifica√ß√£o (usando Web Audio API)
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        notificationSound = function() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        };
    } catch (error) {
        console.log('Som de notifica√ß√£o n√£o dispon√≠vel');
    }
}

// Tocar som de notifica√ß√£o
function playNotificationSound() {
    try {
        if (notificationSound && document.hasFocus && !document.hasFocus()) {
            notificationSound();
        }
    } catch (error) {
        console.log('Som de notifica√ß√£o n√£o dispon√≠vel');
    }
}

// Fun√ß√µes para gerenciar arquivos
function handleFileSelection() {
    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];
    
    console.log('handleFileSelection chamado');
    console.log('Arquivo selecionado:', file);
    
    if (!file) {
        console.log('Nenhum arquivo selecionado');
        return;
    }
    
    console.log('Arquivo:', file.name, 'Tamanho:', file.size, 'Tipo:', file.type);
    
    // Validar tamanho (m√°ximo 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('Arquivo muito grande! M√°ximo 10MB.');
        return;
    }
    
    selectedFile = file;
    console.log('selectedFile definido:', selectedFile);
    
    // Mostrar nome do arquivo no placeholder IMEDIATAMENTE
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.placeholder = `üìé ${file.name} - Digite uma mensagem opcional...`;
        console.log('Placeholder atualizado para:', messageInput.placeholder);
    } else {
        console.error('message-input n√£o encontrado!');
    }
    
    showFilePreview(file);
}

function showFilePreview(file) {
    const preview = document.getElementById('file-preview');
    const extension = file.name.split('.').pop().toLowerCase();
    const iconMap = {
        'jpg': 'fas fa-image', 'jpeg': 'fas fa-image', 'png': 'fas fa-image', 'gif': 'fas fa-image',
        'pdf': 'fas fa-file-pdf', 'doc': 'fas fa-file-word', 'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel', 'xlsx': 'fas fa-file-excel',
        'txt': 'fas fa-file-alt', 'zip': 'fas fa-file-archive', 'rar': 'fas fa-file-archive'
    };
    
    const fileIcon = iconMap[extension] || 'fas fa-file';
    
    // Se for imagem, mostrar preview visual
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <img src="${e.target.result}" alt="${file.name}" 
                             style="width: 60px; height: 60px; object-fit: cover;" class="rounded me-3">
                        <div class="flex-grow-1">
                            <strong>${file.name}</strong>
                            <div class="small text-muted">${formatFileSize(file.size)}</div>
                        </div>
                        <button type="button" class="btn-close" id="remove-file"></button>
                    </div>
                </div>
            `;
            
            // Reativar o bot√£o de remover
            document.getElementById('remove-file').addEventListener('click', clearFileSelection);
            preview.style.display = 'block';
            console.log('Preview de imagem criado');
        };
        reader.readAsDataURL(file);
    } else {
        // Para outros tipos de arquivo, mostrar preview simples
        preview.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="${fileIcon} me-2 fs-3"></i>
                    <div class="flex-grow-1">
                        <strong>${file.name}</strong>
                        <div class="small text-muted">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" class="btn-close" id="remove-file"></button>
                </div>
            </div>
        `;
        
        // Reativar o bot√£o de remover
        document.getElementById('remove-file').addEventListener('click', clearFileSelection);
        preview.style.display = 'block';
        console.log('Preview de arquivo criado');
    }
}

function clearFileSelection() {
    selectedFile = null;
    document.getElementById('file-input').value = '';
    document.getElementById('file-preview').style.display = 'none';
    document.getElementById('message-input').placeholder = 'Digite sua mensagem...';
    console.log('Arquivo removido, preview limpo');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Fechar chat
function closeChat() {
    const modal = new bootstrap.Modal(document.getElementById('closeChatModal'));
    modal.show();
}

function confirmCloseChat() {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'action': 'close_chat'
        }));
    }
    
    // Tamb√©m fazer requisi√ß√£o HTTP
    fetch(`/chat/fechar/${chatRoomId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/chat/meus-chats/';
        }
    });
}

// Manipular chat fechado
function handleChatClosed(data) {
    console.log('handleChatClosed chamada com:', data);
    
    // N√£o processar se chat j√° est√° fechado desde o carregamento inicial
    if (window.chatClosed) {
        console.log('Chat j√° est√° fechado, ignorando handleChatClosed');
        return;
    }
    
    const inputArea = document.querySelector('.border-top.p-3');
    const messagesContainer = document.getElementById('messages-container');
    
    let message = 'Chat foi fechado';
    
    if (data.reason === 'inactivity') {
        message = 'Chat encerrado automaticamente por inatividade (5 minutos sem resposta)';
        
        // Adicionar mensagem de sistema
        if (messagesContainer) {
            const systemMessageDiv = document.createElement('div');
            systemMessageDiv.className = 'alert alert-warning text-center mb-3';
            systemMessageDiv.innerHTML = `
                <i class="fas fa-clock me-2"></i>
                ${data.message}
            `;
            messagesContainer.appendChild(systemMessageDiv);
            scrollToBottom();
        }
    } else if (data.closed_by_username) {
        message = `Chat fechado por ${data.closed_by_username}`;
    }
    
    if (inputArea) {
        inputArea.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-lock me-2"></i>
                ${message}
            </div>
        `;
    }
    
    // Desabilitar funcionalidades do chat
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileButton = document.getElementById('file-button');
    
    if (messageInput) messageInput.disabled = true;
    if (sendButton) sendButton.disabled = true;
    if (fileButton) fileButton.disabled = true;
    
    // Fechar WebSocket ap√≥s 3 segundos
    setTimeout(() => {
        if (chatSocket) {
            chatSocket.close();
        }
    }, 3000);
}

// Ver detalhes do carro
function viewCarDetails() {
    window.open(`/dashboard/carros/{{ car.id }}/`, '_blank');
}

// Reproduzir som de notifica√ß√£o
function playNotificationSound() {
    // Implementar som de notifica√ß√£o se necess√°rio
}

// Escapar HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat carregado - Status:', '{{ chat_room.status }}');
    
    // Verificar se mensagens est√£o carregadas corretamente
    const messagesContainer = document.getElementById('messages-container');
    const existingMessages = messagesContainer.querySelectorAll('.message');
    console.log('Mensagens carregadas:', existingMessages.length);
    
    // Verificar mensagens carregadas
    if (existingMessages.length > 0) {
        console.log('Mensagens carregadas e estilizadas com sucesso');
    }
    
    // Apenas conectar WebSocket se chat estiver ativo
    {% if chat_room.status == 'active' %}
    console.log('Conectando WebSocket para chat ativo...');
    connectWebSocket();
    {% else %}
    console.log('Chat est√° fechado - WebSocket n√£o ser√° conectado');
    // Para chats fechados, garantir que n√£o h√° reconex√£o
    window.chatClosed = true;
    
    // Esconder qualquer indicador de digita√ß√£o que possa estar vis√≠vel
    const typingIndicator = document.getElementById('typing-indicator');
    const typingStatus = document.getElementById('typing-status');
    if (typingIndicator) typingIndicator.style.display = 'none';
    if (typingStatus) typingStatus.style.display = 'none';
    {% endif %}
    initializeNotificationSound();
    
    // Limpar qualquer indicador de digita√ß√£o que possa estar ativo
    setTimeout(() => {
        // For√ßa esconder TODOS os indicadores de digita√ß√£o
        const allTypingIndicators = document.querySelectorAll('[id*="typing"]');
        allTypingIndicators.forEach(el => {
            el.classList.remove('show-typing');
            el.style.display = 'none !important';
            el.style.visibility = 'hidden !important';
            el.style.opacity = '0 !important';
            el.style.height = '0 !important';
            console.log('For√ßadamente escondido:', el.id);
        });
        
        // Resetar estado local
        isTyping = false;
        clearTimeout(typingTimer);
        
        // N√ÉO chamar stopTyping aqui para evitar enviar sinais desnecess√°rios
        console.log('Estado de digita√ß√£o resetado no carregamento');
    }, 1000); // Aumentar para 1 segundo
    
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileButton = document.getElementById('file-button');
    const fileInput = document.getElementById('file-input');
    const removeFileButton = document.getElementById('remove-file');
    
    if (messageInput && sendButton) {
        // Enviar mensagem ao pressionar Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Indicar digita√ß√£o
        messageInput.addEventListener('input', startTyping);
        
        // Parar digita√ß√£o quando campo perde foco
        messageInput.addEventListener('blur', () => {
            console.log('Campo de input perdeu foco - parando digita√ß√£o');
            stopTyping();
        });
        
        // Enviar mensagem ao clicar no bot√£o
        sendButton.addEventListener('click', sendMessage);
    }
    
    // Bot√£o de arquivo (apenas para chats ativos)
    if (fileButton && fileInput) {
        fileButton.addEventListener('click', function() {
            console.log('Bot√£o de arquivo clicado');
            fileInput.click();
        });
        
        fileInput.addEventListener('change', handleFileSelection);
        console.log('Event listeners de arquivo configurados');
    } else if ('{{ chat_room.status }}' === 'active') {
        console.error('fileButton ou fileInput n√£o encontrados!');
        console.log('fileButton:', fileButton);
        console.log('fileInput:', fileInput);
    }
    
    // Remover arquivo selecionado
    if (removeFileButton) {
        removeFileButton.addEventListener('click', clearFileSelection);
    }
    
    // Rolar para o final ao carregar
    scrollToBottom();
    
    // Desabilitar controles se chat estiver fechado
    {% if chat_room.status == 'closed' %}
    disableChatControls();
    {% endif %}
    
    // Workaround: Limpar indicadores travados a cada 10 segundos
    setInterval(() => {
        if (!isTyping) {  // S√≥ limpar se realmente n√£o estiver digitando
            const typingIndicator = document.getElementById('typing-indicator');
            const typingStatus = document.getElementById('typing-status');
            if (typingIndicator && typingIndicator.style.display === 'block') {
                console.log('Limpeza for√ßada - indicador travado detectado');
                typingIndicator.style.display = 'none';
            }
            if (typingStatus && typingStatus.style.display === 'block') {
                console.log('Limpeza for√ßada - status travado detectado');
                typingStatus.style.display = 'none';
            }
        }
    }, 10000); // A cada 10 segundos
    

});

// Fun√ß√£o para desabilitar controles do chat fechado
function disableChatControls() {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileButton = document.getElementById('file-button');
    const fileInput = document.getElementById('file-input');
    
    if (messageInput) {
        messageInput.disabled = true;
        messageInput.placeholder = 'Chat encerrado - apenas visualiza√ß√£o';
    }
    if (sendButton) {
        sendButton.disabled = true;
        sendButton.classList.add('btn-secondary');
        sendButton.classList.remove('btn-primary');
    }
    if (fileButton) {
        fileButton.disabled = true;
        fileButton.classList.add('btn-secondary');
        fileButton.classList.remove('btn-outline-secondary');
    }
    if (fileInput) {
        fileInput.disabled = true;
    }
}

// Fechar conex√£o ao sair da p√°gina
window.addEventListener('beforeunload', function() {
    if (chatSocket) {
        chatSocket.close();
    }
});
</script>
{% endblock %}
